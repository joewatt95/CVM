\section{Formalization of the CVM algorithm}\label{sec:formalization}
The supplementary material contains a formalization of the CVM algorithm, both the original version (\cref{alg:cvm}) and our new version (\cref{alg:cvm_new}) with the approach presented in \cref{sec:invariants}.

A snippet of the formalization of the new version of the algorithm is presented in \cref{alg:cvm_formalized}.
%The snippet also includes the relevant correctness statements, both unbiasedness and tail bounds. 
We use the same variables as in the informal presentation: $n$ for the maximal size of the buffer, $f$ for the fraction of elements to keep in the buffer when subsampling.
The condition \isa{{\isacartoucheopen}n\ {\isacharasterisk}{\kern0pt}\ f\ {\isasymin}\ {\isasymnat}{\isacartoucheclose}} expresses the requirement that the $nf$ must be integer.
Instead of representing the state using pairs, as we did in the informal proof, we use a datatype with the single constructor \isa{State}, which has two arguments $\chi$ and $p$, the buffer and the probability, that the stream elements are in the buffer.
Isabelle provides notation closely related to informal pseudocode, such that it is usually feasible to read a formalization without expert knowledge.
Nevertheless, \cref{tab:isabelle_syntax} contains brief descriptions of the syntactic elements used in the listing.
%\medskip
\begin{table}
\caption{Isabelle syntax used in \cref{alg:cvm_formalized}.}\label{tab:isabelle_syntax}
\noindent\begin{tabular}{l p{9cm}}
\toprule
Term & Description \\
\midrule
\isa{card\ S} & Cardinality of a finite set $S$. \\
%\isa{set\ xs} & For a sequence \isa{xs} the set of elements in the sequence. \\
%\isa{length\ xs} & For a sequence \isa{xs} the length of the sequence. \\
\isa{real} & Type of real numbers and conversion between natural numbers into real numbers. \\
\isa{nat} & Type of natural numbers (non-negative integers). \\
\isa{bernoulli{\isacharunderscore}pmf\ p} & The probability space over the boolean values, where the probability of \isa{True} is $p$. (Bernoulli distribution.) \\
\isa{pmf{\isacharunderscore}of{\isacharunderscore}set\ S} & For a finite set $S$, the uniform probability space on $S$. (Every element of $S$ is equiprobable.) \\
\isa{map{\isacharunderscore}pmf\ f\ A} & The probability space representing the distribution of the random variable $f$ over the probability space $A$. \\
\isa{return{\isacharunderscore}pmf\ x} & The probability space of the singleton $\{x\}$. \\
\isa{foldM{\isacharunderscore}pmf\ f\ xs\ a} & Iterate randomized algorithm $f$ over the sequence $xs$ using the initial state $a$. \\
%\isa{\isasymP{\isacharparenleft}x\ in\ M{\isachardot}\ P\ x\isacharparenright} & Probability of predicate $P$ in the probability space $M$. \\
%\isa{measure{\isacharunderscore}pmf{\isachardot}expectation\ M\ f} & Expectation of the random variable $f$ over the probability space $M$. \\
\bottomrule
\end{tabular}
\end{table}
%\medskip
The theorem that establishes the correctness of the algorithm, i.e., that the relative error will be smaller than $\varepsilon$ with probability $1-\delta$ is expresed in the following snippet:
\begin{isabelle_cm}
\isacommand{theorem}\isamarkupfalse%
\ correctness{\isacharcolon}{\kern0pt}\isanewline
\ \ \isakeyword{assumes}\ {\isacartoucheopen}{\isasymepsilon}\ {\isasymin}\ {\isacharbraceleft}{\kern0pt}{\isadigit{0}}{\isacharless}{\kern0pt}{\isachardot}{\kern0pt}{\isachardot}{\kern0pt}{\isacharless}{\kern0pt}{\isadigit{1}}{\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}real{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\ {\isacartoucheopen}{\isasymdelta}\ {\isasymin}\ {\isacharbraceleft}{\kern0pt}{\isadigit{0}}{\isacharless}{\kern0pt}{\isachardot}{\kern0pt}{\isachardot}{\kern0pt}{\isacharless}{\kern0pt}{\isadigit{1}}{\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}real{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\isanewline
\ \ \isakeyword{assumes}\ {\isacartoucheopen}real\ n\ {\isasymge}\ {\isadigit{1}}{\isadigit{2}}\ {\isacharslash}{\kern0pt}\ {\isasymepsilon}\isactrlsup {\isadigit{2}}\ {\isacharasterisk}{\kern0pt}\ ln\ {\isacharparenleft}{\kern0pt}{\isadigit{3}}\ {\isacharasterisk}{\kern0pt}\ real\ {\isacharparenleft}{\kern0pt}length\ xs{\isacharparenright}{\kern0pt}\ {\isacharslash}{\kern0pt}\ {\isasymdelta}{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
\ \ \isakeyword{defines}\ {\isacartoucheopen}A\ {\isasymequiv}\ real\ {\isacharparenleft}{\kern0pt}card\ {\isacharparenleft}{\kern0pt}set\ xs{\isacharparenright}{\kern0pt}{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
\ \ \isakeyword{shows}\ {\isacartoucheopen}{\isasymP}{\isacharparenleft}{\kern0pt}R\ in\ run{\isacharunderscore}{\kern0pt}algo\ xs{\isachardot}{\kern0pt}\ {\isasymbar}R\ {\isacharminus}{\kern0pt}\ A{\isasymbar}\ {\isachargreater}{\kern0pt}\ {\isasymepsilon}\ {\isacharasterisk}{\kern0pt}\ A{\isacharparenright}{\kern0pt}\ {\isasymle}\ {\isasymdelta}{\isacartoucheclose}
\end{isabelle_cm}
The first line establish the conditions on $\varepsilon$ and $\delta$, which must be strictly between $0$ and $1$.
The next line requires the buffer size $n$ to be larger than $12 \varepsilon^{-2} \ln ( 3 \delta^{-1} l)$.
This is a bit more general than the original algorithm, where we fix $n$ to be the smallest integer larger than the same value.
Then we define $A$ to be the cardinality of the set of elements in sequence \isa{xs}:
More precisely \isa{set\ xs} denotes the set of distinct elements in a given sequence, and \isa{card} returns the cardinality of a finite set.
The notation \isa{\isasymP{\isacharparenleft}x\ in\ M{\isachardot}\ P\ x\isacharparenright} denotes the probability of a predicate $P$ in the probability space $M$.

Similarly the unbiasedness is also a theorem:
\begin{isabelle_cm}
\isacommand{theorem}\isamarkupfalse%
\ unbiasedness{\isacharcolon}{\kern0pt}\ {\isacartoucheopen}measure{\isacharunderscore}{\kern0pt}pmf{\isachardot}{\kern0pt}expectation\ {\isacharparenleft}{\kern0pt}run{\isacharunderscore}{\kern0pt}algo\ xs{\isacharparenright}{\kern0pt}\ id\ {\isacharequal}{\kern0pt}\ card\ {\isacharparenleft}{\kern0pt}set\ xs{\isacharparenright}{\kern0pt}{\isacartoucheclose}
\end{isabelle_cm}
The expression \isa{measure{\isacharunderscore}pmf{\isachardot}expectation\ M\ f} denotes the expectation of the random variable \isa{f} on the probabibiltiy space \isa{M}.

The formalization contains four theory files. The file CVM{\textunderscore}Preliminary definitions and lemmas, such as properties about the \isa{foldM{\isacharunderscore}pmf\ f\ xs\ a} operation we introduced.
Of course, we do not verify \cref{alg:cvm} and \cref{alg:cvm_new} separately,
as most of the proof is identical.
The file CVM{\textunderscore}Abstract{\textunderscore}Algorithm verifies a generalized version of the CVM algorithm, with an abstract subsampling operation, which is required to fulfill \cref{eq:subsample_condition}.
The specialization happens in the following theories CVM{\textunderscore}Original{\textunderscore}Algorithm (resp. CVM{\textunderscore}New{\textunderscore}Algorithm).
It should be noted that only the last file, for the new unbiased algorithm, dependends on the new library (\cref{sec:formalization_neg_dep}) on negatively associated random variables.
The total number of lines required for the verification of the original algorithm is 1004 lines.
This is in contrast to the original proof, for which the verification required \todo{x} lines.
\begin{algorithm}[t]
\caption{Formalized Version of \cref{alg:cvm_new}}\label{alg:cvm_formalized}
\begin{isabelle_cm}
\isacommand{context}\isamarkupfalse%
\isanewline
\ \ \isakeyword{fixes}\ f\ {\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}\ real\ \isakeyword{and}\ n\ {\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}\ nat\isanewline
\ \ \isakeyword{assumes}\ f{\isacharunderscore}{\kern0pt}range{\isacharcolon}{\kern0pt}\ {\isacartoucheopen}f\ {\isasymin}\ {\isacharbraceleft}{\kern0pt}{\isadigit{1}}{\isacharslash}{\kern0pt}{\isadigit{2}}{\isachardot}{\kern0pt}{\isachardot}{\kern0pt}{\isacharless}{\kern0pt}{\isadigit{1}}{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\ {\isacartoucheopen}n\ {\isacharasterisk}{\kern0pt}\ f\ {\isasymin}\ {\isasymnat}{\isacartoucheclose}\ \isakeyword{and}\ n{\isacharunderscore}{\kern0pt}gt{\isacharunderscore}{\kern0pt}{\isadigit{0}}{\isacharcolon}{\kern0pt}\ {\isacartoucheopen}n\ {\isachargreater}{\kern0pt}\ {\isadigit{0}}{\isacartoucheclose}\isanewline
\isakeyword{begin}\isanewline
\isanewline
\isacommand{definition}\isamarkupfalse%
\ {\isacartoucheopen}initial{\isacharunderscore}{\kern0pt}state\ {\isacharequal}{\kern0pt}\ State\ {\isacharbraceleft}{\kern0pt}{\isacharbraceright}{\kern0pt}\ {\isadigit{1}}{\isacartoucheclose}\ %
\hfill\isamarkupcmt{Setup initial state $\chi=\emptyset$ and $p=1$.\;%
}\isanewline
\isacommand{fun}\isamarkupfalse%
\ subsample\ \isakeyword{where}\ %
\hfill\isamarkupcmt{Subsampling operation: Sample random $n f$ subset.\;%
}\isanewline
\ \ {\isacartoucheopen}subsample\ {\isasymchi}\ {\isacharequal}{\kern0pt}\ pmf{\isacharunderscore}{\kern0pt}of{\isacharunderscore}{\kern0pt}set\ {\isacharbraceleft}{\kern0pt}S{\isachardot}{\kern0pt}\ S\ {\isasymsubseteq}\ {\isasymchi}\ {\isasymand}\ card\ S\ {\isacharequal}{\kern0pt}\ n\ {\isacharasterisk}{\kern0pt}\ f{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\isanewline
\isanewline
\isacommand{fun}\isamarkupfalse%
\ step\ \isakeyword{where}\ %
\hfill\isamarkupcmt{Loop body.\;%
}\isanewline
\ \ {\isacartoucheopen}step\ a\ {\isacharparenleft}{\kern0pt}State\ {\isasymchi}\ p{\isacharparenright}{\kern0pt}\ {\isacharequal}{\kern0pt}\ do\ {\isacharbraceleft}{\kern0pt}\isanewline
\ \ \ \ b\ {\isasymleftarrow}\ bernoulli{\isacharunderscore}{\kern0pt}pmf\ p{\isacharsemicolon}{\kern0pt}\isanewline
\ \ \ \ let\ {\isasymchi}\ {\isacharequal}{\kern0pt}\ {\isacharparenleft}{\kern0pt}if\ b\ then\ {\isasymchi}\ {\isasymunion}\ {\isacharbraceleft}{\kern0pt}a{\isacharbraceright}{\kern0pt}\ else\ {\isasymchi}\ {\isacharminus}{\kern0pt}\ {\isacharbraceleft}{\kern0pt}a{\isacharbraceright}{\kern0pt}{\isacharparenright}{\kern0pt}{\isacharsemicolon}{\kern0pt}\isanewline
\isanewline
\ \ \ \ if\ card\ {\isasymchi}\ {\isacharequal}{\kern0pt}\ n\ then\ do\ {\isacharbraceleft}{\kern0pt}\isanewline
\ \ \ \ \ \ {\isasymchi}\ {\isasymleftarrow}\ subsample\ {\isasymchi}{\isacharsemicolon}{\kern0pt}\isanewline
\ \ \ \ \ \ return{\isacharunderscore}{\kern0pt}pmf\ {\isacharparenleft}{\kern0pt}State\ {\isasymchi}\ {\isacharparenleft}{\kern0pt}p\ {\isacharasterisk}{\kern0pt}\ f{\isacharparenright}{\kern0pt}{\isacharparenright}{\kern0pt}\isanewline
\ \ \ \ {\isacharbraceright}{\kern0pt}\ else\ do\ {\isacharbraceleft}{\kern0pt}\isanewline
\ \ \ \ \ \ return{\isacharunderscore}{\kern0pt}pmf\ {\isacharparenleft}{\kern0pt}State\ {\isasymchi}\ p{\isacharparenright}{\kern0pt}\isanewline
\ \ \ \ {\isacharbraceright}{\kern0pt}\isanewline
\ \ \ {\isacharbraceright}{\kern0pt}{\isacartoucheclose}\isanewline
\isanewline
\isacommand{fun}\isamarkupfalse%
\ run{\isacharunderscore}{\kern0pt}steps\ \isakeyword{where}\ %
\hfill\isamarkupcmt{Iterate loop over stream \isa{xs}.\;%
}\isanewline
\ \ {\isacartoucheopen}run{\isacharunderscore}{\kern0pt}steps\ xs\ {\isacharequal}{\kern0pt}\ foldM{\isacharunderscore}{\kern0pt}pmf\ step\ xs\ initial{\isacharunderscore}{\kern0pt}state{\isacartoucheclose}\isanewline
\isacommand{fun}\isamarkupfalse%
\ estimate\ \isakeyword{where}\ 
{\isacartoucheopen}estimate\ {\isacharparenleft}{\kern0pt}State\ {\isasymchi}\ p{\isacharparenright}{\kern0pt}\ {\isacharequal}{\kern0pt}\ card\ {\isasymchi}\ {\isacharslash}{\kern0pt}\ p{\isacartoucheclose}\isanewline
\isacommand{fun}\isamarkupfalse%
\ run{\isacharunderscore}{\kern0pt}algo\ \isakeyword{where}\ %
\hfill\isamarkupcmt{Run algorithm and estimate.\;%
}\isanewline
\ \ {\isacartoucheopen}run{\isacharunderscore}{\kern0pt}algo\ xs\ {\isacharequal}{\kern0pt}\ map{\isacharunderscore}{\kern0pt}pmf\ estimate\ {\isacharparenleft}{\kern0pt}run{\isacharunderscore}{\kern0pt}steps\ xs{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
%\isanewline
%\isacommand{theorem}\isamarkupfalse%
%\ unbiasedness{\isacharcolon}{\kern0pt}\ {\isacartoucheopen}measure{\isacharunderscore}{\kern0pt}pmf{\isachardot}{\kern0pt}expectation\ {\isacharparenleft}{\kern0pt}run{\isacharunderscore}{\kern0pt}algo\ xs{\isacharparenright}{\kern0pt}\ id\ {\isacharequal}{\kern0pt}\ card\ {\isacharparenleft}{\kern0pt}set\ xs{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
%\isanewline
%\isacommand{theorem}\isamarkupfalse%
%\ correctness{\isacharcolon}{\kern0pt}\isanewline
%\ \ \isakeyword{assumes}\ {\isacartoucheopen}{\isasymepsilon}\ {\isasymin}\ {\isacharbraceleft}{\kern0pt}{\isadigit{0}}{\isacharless}{\kern0pt}{\isachardot}{\kern0pt}{\isachardot}{\kern0pt}{\isacharless}{\kern0pt}{\isadigit{1}}{\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}real{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\ {\isacartoucheopen}{\isasymdelta}\ {\isasymin}\ {\isacharbraceleft}{\kern0pt}{\isadigit{0}}{\isacharless}{\kern0pt}{\isachardot}{\kern0pt}{\isachardot}{\kern0pt}{\isacharless}{\kern0pt}{\isadigit{1}}{\isacharcolon}{\kern0pt}{\isacharcolon}{\kern0pt}real{\isacharbraceright}{\kern0pt}{\isacartoucheclose}\isanewline
%\ \ \isakeyword{assumes}\ {\isacartoucheopen}real\ n\ {\isasymge}\ {\isadigit{1}}{\isadigit{2}}\ {\isacharslash}{\kern0pt}\ {\isasymepsilon}\isactrlsup {\isadigit{2}}\ {\isacharasterisk}{\kern0pt}\ ln\ {\isacharparenleft}{\kern0pt}{\isadigit{3}}\ {\isacharasterisk}{\kern0pt}\ real\ {\isacharparenleft}{\kern0pt}length\ xs{\isacharparenright}{\kern0pt}\ {\isacharslash}{\kern0pt}\ {\isasymdelta}{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
%\ \ \isakeyword{defines}\ {\isacartoucheopen}A\ {\isasymequiv}\ real\ {\isacharparenleft}{\kern0pt}card\ {\isacharparenleft}{\kern0pt}set\ xs{\isacharparenright}{\kern0pt}{\isacharparenright}{\kern0pt}{\isacartoucheclose}\isanewline
%\ \ \isakeyword{shows}\ {\isacartoucheopen}{\isasymP}{\isacharparenleft}{\kern0pt}R\ in\ run{\isacharunderscore}{\kern0pt}algo\ xs{\isachardot}{\kern0pt}\ {\isasymbar}R\ {\isacharminus}{\kern0pt}\ A{\isasymbar}\ {\isachargreater}{\kern0pt}\ {\isasymepsilon}\ {\isacharasterisk}{\kern0pt}\ A{\isacharparenright}{\kern0pt}\ {\isasymle}\ {\isasymdelta}{\isacartoucheclose}\isanewline
{\normalfont [\dots]}\isanewline
\isacommand{end}
\end{isabelle_cm}
\end{algorithm}

